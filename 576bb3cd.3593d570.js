(window.webpackJsonp=window.webpackJsonp||[]).push([[32],{185:function(e,t,n){"use strict";n.r(t),n.d(t,"frontMatter",(function(){return i})),n.d(t,"metadata",(function(){return s})),n.d(t,"rightToc",(function(){return l})),n.d(t,"default",(function(){return u}));var r=n(2),a=n(11),o=(n(0),n(242)),i={id:"component-worker",title:"Workers",sidebar_label:"Workers"},s={id:"component-worker",isDocsHomePage:!1,title:"Workers",description:"Dark supports doing work asynchronously outside the context of an HTTP handler",source:"@site/docs/component-worker.md",permalink:"/component-worker",sidebar_label:"Workers",sidebar:"docs",previous:{title:"Error Handling",permalink:"/error-handling"},next:{title:"Cron",permalink:"/component-cron"}},l=[{value:"Worker Basics",id:"worker-basics",children:[]},{value:"Creating a Worker",id:"creating-a-worker",children:[]},{value:"FAQ",id:"faq",children:[{value:"How do I access the data from <code>emit</code> in the worker?",id:"how-do-i-access-the-data-from-emit-in-the-worker",children:[]},{value:"Do workers execute in parallel?",id:"do-workers-execute-in-parallel",children:[]},{value:"Can I control the concurrency of my worker?",id:"can-i-control-the-concurrency-of-my-worker",children:[]},{value:"Can I un-enqueue a message?",id:"can-i-un-enqueue-a-message",children:[]},{value:"Do workers guarantee exactly-once delivery?",id:"do-workers-guarantee-exactly-once-delivery",children:[]},{value:"How do I wait for a worker to finish?",id:"how-do-i-wait-for-a-worker-to-finish",children:[]},{value:"Can I call <code>emit</code> from a Worker?",id:"can-i-call-emit-from-a-worker",children:[]},{value:"How can I tell how long a message was enqueued?",id:"how-can-i-tell-how-long-a-message-was-enqueued",children:[]},{value:"Why does my worker show pending messages that aren\u2019t being processed?",id:"why-does-my-worker-show-pending-messages-that-arent-being-processed",children:[]},{value:"What happens when a message fails?",id:"what-happens-when-a-message-fails",children:[]},{value:"How long will it take my worker to execute?",id:"how-long-will-it-take-my-worker-to-execute",children:[]}]},{value:"Future Improvements",id:"future-improvements",children:[]}],c={rightToc:l};function u(e){var t=e.components,n=Object(a.a)(e,["components"]);return Object(o.b)("wrapper",Object(r.a)({},c,n,{components:t,mdxType:"MDXLayout"}),Object(o.b)("p",null,"Dark supports doing work asynchronously outside the context of an HTTP handler\nusing a ",Object(o.b)("strong",{parentName:"p"},"Worker"),". Each worker has a queue of messages, which are processed\nloosely in-order, executing the code within the Worker once for each message.\nMessages are created by calling ",Object(o.b)("inlineCode",{parentName:"p"},"emit")," from any other code, and can contain\narbitrary event data."),Object(o.b)("p",null,Object(o.b)("img",Object(r.a)({parentName:"p"},{src:"/img/workers/emit.png",alt:"REPL with emit to worker"}))),Object(o.b)("p",null,Object(o.b)("img",Object(r.a)({parentName:"p"},{src:"/img/workers/worker.png",alt:"basic worker"}))),Object(o.b)("iframe",{width:"560",height:"315",src:"https://www.youtube.com/embed/JpfZIdde_5I",frameborder:"0",allow:"accelerometer; autoplay; encrypted-media; gyroscope; picture-in-picture",allowfullscreen:!0}),Object(o.b)("h2",{id:"worker-basics"},"Worker Basics"),Object(o.b)("ul",null,Object(o.b)("li",{parentName:"ul"},"Workers will automatically process each message. The ",Object(o.b)("inlineCode",{parentName:"li"},"event")," data passed to\n",Object(o.b)("inlineCode",{parentName:"li"},"emit")," is available in the Worker as a special variable ",Object(o.b)("inlineCode",{parentName:"li"},"event"),". This can be\nof any type, but it is often convenient to use a Dict holding many other\nvalues."),Object(o.b)("li",{parentName:"ul"},"Workers process messages roughly in the order that they were received.\nGenerally, older messages are processed first, but strict ordering is not\nguaranteed."),Object(o.b)("li",{parentName:"ul"},"A message should be processed within a minute of being emitted. Typically,\nprocessing begins within a few seconds."),Object(o.b)("li",{parentName:"ul"},"If there are multiple items in the queue, a live count of queue items will\nappear at the top left."),Object(o.b)("li",{parentName:"ul"},'You can pause the queue by hitting the "pause" button in case of operational\nissues or if you\'d like to stop and debug.'),Object(o.b)("li",{parentName:"ul"},"The last 10 processed events will show as traces that you can use for\ndebugging purposes."),Object(o.b)("li",{parentName:"ul"},"Workers will not alert you of failures unless you write logic to do so.")),Object(o.b)("h2",{id:"creating-a-worker"},"Creating a Worker"),Object(o.b)("p",null,"Workers can be created from the omnibox or sidebar."),Object(o.b)("p",null,"Similar to HTTP handlers, calling ",Object(o.b)("inlineCode",{parentName:"p"},"emit")," with a nonexistent Worker name will\npopulate that worker in the 404 sidebar section, allowing it to be created."),Object(o.b)("p",null,Object(o.b)("img",Object(r.a)({parentName:"p"},{src:"/img/workers/404.png",alt:"404 worker"}))),Object(o.b)("p",null,"Creating a Worker from a 404 may result in a delay when executing the first\nmessage. When a new worker is created, it immediately processed the first\nmessage in the queue, but returns ",Object(o.b)("inlineCode",{parentName:"p"},"Incomplete")," because no code has been written\nyet. This causes the message to get automatically retried in 5 minutes, but\nuntil then it may look like no messages are being processed."),Object(o.b)("p",null,"This is all quite confusing, so for now we recommend creating the Worker and\ncompleting its code first, before emitting events to it."),Object(o.b)("h2",{id:"faq"},"FAQ"),Object(o.b)("h3",{id:"how-do-i-access-the-data-from-emit-in-the-worker"},"How do I access the data from ",Object(o.b)("inlineCode",{parentName:"h3"},"emit")," in the worker?"),Object(o.b)("p",null,"The data from the ",Object(o.b)("inlineCode",{parentName:"p"},"emit")," is available in a variable called ",Object(o.b)("inlineCode",{parentName:"p"},"event")," from within\nthe worker. Its type will be whatever was passed to ",Object(o.b)("inlineCode",{parentName:"p"},"emit")," (eg,\n",Object(o.b)("inlineCode",{parentName:"p"},"emit [1, 2] \u201cmy-worker\u201d")," will have ",Object(o.b)("inlineCode",{parentName:"p"},"event")," = ",Object(o.b)("inlineCode",{parentName:"p"},"[1, 2]")),Object(o.b)("h3",{id:"do-workers-execute-in-parallel"},"Do workers execute in parallel?"),Object(o.b)("p",null,"Yes. Workers across a canvas execute in parallel, and multiple messages for a\nworker may be processed in parallel."),Object(o.b)("h3",{id:"can-i-control-the-concurrency-of-my-worker"},"Can I control the concurrency of my worker?"),Object(o.b)("p",null,"No. If multiple messages are enqueued for a worker, the Dark platform may\nexecute them concurrently. We intend to eventually add controls for managing\nconcurrency."),Object(o.b)("h3",{id:"can-i-un-enqueue-a-message"},"Can I un-enqueue a message?"),Object(o.b)("p",null,"No, this is not currently possible. An alternative would be to give each message\na unique UUID, then create a datastore of message IDs to ignore, checking it\nwithin your worker."),Object(o.b)("h3",{id:"do-workers-guarantee-exactly-once-delivery"},"Do workers guarantee exactly-once delivery?"),Object(o.b)("p",null,"No. Messages have at-least-once delivery semantics. Adding a unique UUID to\nevery message can be useful in keeping track of which messages have been seen by\nyour worker already."),Object(o.b)("h3",{id:"how-do-i-wait-for-a-worker-to-finish"},"How do I wait for a worker to finish?"),Object(o.b)("p",null,"The code that calls ",Object(o.b)("inlineCode",{parentName:"p"},"emit")," has no way to know when a worker has completed. If\nyou need a synchronous call, consider a function instead."),Object(o.b)("h3",{id:"can-i-call-emit-from-a-worker"},"Can I call ",Object(o.b)("inlineCode",{parentName:"h3"},"emit")," from a Worker?"),Object(o.b)("p",null,"Yes. This can be useful to do fan-out of work or batch processing of data."),Object(o.b)("p",null,"In fact, you can ",Object(o.b)("inlineCode",{parentName:"p"},"emit")," to the same Worker that's processing the message. Just\nbe careful that you don't cause a infinite loop or positive feedback loop. (We\nare likely to disable your Worker if this happens, as it can cause instability\nof the entire worker infrastructure right now.)"),Object(o.b)("h3",{id:"how-can-i-tell-how-long-a-message-was-enqueued"},"How can I tell how long a message was enqueued?"),Object(o.b)("p",null,"We currently don\u2019t have a way to get this information directly. You can\ncalculate this yourself by adding a timestamp to each message when you call\n",Object(o.b)("inlineCode",{parentName:"p"},"emit"),"."),Object(o.b)("h3",{id:"why-does-my-worker-show-pending-messages-that-arent-being-processed"},"Why does my worker show pending messages that aren\u2019t being processed?"),Object(o.b)("p",null,"Your worker is paused and will not process messages while paused. Click the play\nbutton at the top left of the worker to resume processing."),Object(o.b)("p",null,Object(o.b)("img",Object(r.a)({parentName:"p"},{src:"/img/workers/pending.png",alt:"paused worker with pending messages"}))),Object(o.b)("p",null,"Alternatively, you emitted messages to a non-existent Worker and then created it\nfrom the 404 section (see the warning above in ",Object(o.b)("strong",{parentName:"p"},"Creating a Worker"),"). Complete\nthe code in the handler and wait up to 5 minutes for the message to be\nre-processed."),Object(o.b)("h3",{id:"what-happens-when-a-message-fails"},"What happens when a message fails?"),Object(o.b)("p",null,"Nothing special. A message that causes a worker to throw a runtime error (for\nexample by returning Incomplete or having a function call go to the Error Rail)\nwill be silently ignored and the worker will process the next message. We plan\nto eventually add more error handling capabilities such as automatic retries and\ndead-letter-queues."),Object(o.b)("h3",{id:"how-long-will-it-take-my-worker-to-execute"},"How long will it take my worker to execute?"),Object(o.b)("p",null,"Your Worker executes code the same as any other Dark component. For example,\nmaking external HTTP calls will cause execution to take longer."),Object(o.b)("h2",{id:"future-improvements"},"Future Improvements"),Object(o.b)("p",null,"This is a list of improvements we'd like to make to Workers. If you have\nopinions on how these might work or other ideas, please reach out in the\n",Object(o.b)("a",Object(r.a)({parentName:"p"},{href:"https://darklang.com/slack-invite"}),"#general")," Slack channel. If you're\ninterested in contributing any of this functionality, get in touch in\n",Object(o.b)("a",Object(r.a)({parentName:"p"},{href:"https://darklang.com/slack-invite"}),"#contributors"),"."),Object(o.b)("ul",null,Object(o.b)("li",{parentName:"ul"},"Error handling: automatic retry, dead-letter queue"),Object(o.b)("li",{parentName:"ul"},"Concurrency control, allowing for tuning how many messages a Worker will\nprocess in parallel"),Object(o.b)("li",{parentName:"ul"},"Queue introspection to see more about the messages in the queue")))}u.isMDXComponent=!0},242:function(e,t,n){"use strict";n.d(t,"a",(function(){return p})),n.d(t,"b",(function(){return m}));var r=n(0),a=n.n(r);function o(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}function i(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(e);t&&(r=r.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,r)}return n}function s(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?i(Object(n),!0).forEach((function(t){o(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):i(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}function l(e,t){if(null==e)return{};var n,r,a=function(e,t){if(null==e)return{};var n,r,a={},o=Object.keys(e);for(r=0;r<o.length;r++)n=o[r],t.indexOf(n)>=0||(a[n]=e[n]);return a}(e,t);if(Object.getOwnPropertySymbols){var o=Object.getOwnPropertySymbols(e);for(r=0;r<o.length;r++)n=o[r],t.indexOf(n)>=0||Object.prototype.propertyIsEnumerable.call(e,n)&&(a[n]=e[n])}return a}var c=a.a.createContext({}),u=function(e){var t=a.a.useContext(c),n=t;return e&&(n="function"==typeof e?e(t):s(s({},t),e)),n},p=function(e){var t=u(e.components);return a.a.createElement(c.Provider,{value:t},e.children)},b={inlineCode:"code",wrapper:function(e){var t=e.children;return a.a.createElement(a.a.Fragment,{},t)}},d=a.a.forwardRef((function(e,t){var n=e.components,r=e.mdxType,o=e.originalType,i=e.parentName,c=l(e,["components","mdxType","originalType","parentName"]),p=u(n),d=r,m=p["".concat(i,".").concat(d)]||p[d]||b[d]||o;return n?a.a.createElement(m,s(s({ref:t},c),{},{components:n})):a.a.createElement(m,s({ref:t},c))}));function m(e,t){var n=arguments,r=t&&t.mdxType;if("string"==typeof e||r){var o=n.length,i=new Array(o);i[0]=d;var s={};for(var l in t)hasOwnProperty.call(t,l)&&(s[l]=t[l]);s.originalType=e,s.mdxType="string"==typeof e?e:r,i[1]=s;for(var c=2;c<o;c++)i[c]=n[c];return a.a.createElement.apply(null,i)}return a.a.createElement.apply(null,n)}d.displayName="MDXCreateElement"}}]);