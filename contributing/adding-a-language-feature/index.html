<!doctype html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width">
<meta name="generator" content="Docusaurus v2.0.0-alpha.58">
<link rel="preconnect" href="https://www.google-analytics.com">
<script>window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)},ga.l=+new Date,ga("create","UA-159199190-1","auto"),ga("send","pageview")</script>
<script async src="https://www.google-analytics.com/analytics.js"></script>
<link rel="search" type="application/opensearchdescription+xml" title="Dark Documentation" href="/opensearch.xml"><title data-react-helmet="true">Adding a language feature | Dark Documentation</title><meta data-react-helmet="true" property="og:image" content="https://docs.darklang.com/img/favicon.ico"><meta data-react-helmet="true" property="twitter:image" content="https://docs.darklang.com/img/favicon.ico"><meta data-react-helmet="true" name="twitter:image:alt" content="Image for Dark Documentation"><meta data-react-helmet="true" name="twitter:card" content="summary_large_image"><meta data-react-helmet="true" property="og:title" content="Adding a language feature | Dark Documentation"><meta data-react-helmet="true" name="description" content="There are a number of"><meta data-react-helmet="true" property="og:description" content="There are a number of"><meta data-react-helmet="true" property="og:url" content="https://docs.darklang.com/contributing/adding-a-language-feature"><link data-react-helmet="true" rel="shortcut icon" href="/img/favicon.ico"><link data-react-helmet="true" rel="canonical" href="https://docs.darklang.com/contributing/adding-a-language-feature"><link rel="stylesheet" href="/styles.f03e3bc4.css">
<link rel="preload" href="/styles.07077e44.js" as="script">
<link rel="preload" href="/runtime~main.971aee17.js" as="script">
<link rel="preload" href="/main.70223205.js" as="script">
<link rel="preload" href="/1.14df050a.js" as="script">
<link rel="preload" href="/2.b7a2668d.js" as="script">
<link rel="preload" href="/90.44038b43.js" as="script">
<link rel="preload" href="/91.fb068903.js" as="script">
<link rel="preload" href="/05c17924.1b0ba798.js" as="script">
<link rel="preload" href="/17896441.60fa8c2c.js" as="script">
<link rel="preload" href="/d9df5485.66a5954a.js" as="script">
</head>
<body>
<script>!function(){function t(t){document.documentElement.setAttribute("data-theme",t)}var e=window.matchMedia("(prefers-color-scheme: dark)"),n=function(){var t=null;try{t=localStorage.getItem("theme")}catch(t){}return t}();null!==n?t(n):e.matches&&t("dark")}()</script><div id="__docusaurus">
<nav class="navbar navbar--light navbar--fixed-top"><div class="navbar__inner"><div class="navbar__items"><div aria-label="Navigation bar toggle" class="navbar__toggle" role="button" tabindex="0"><svg xmlns="http://www.w3.org/2000/svg" width="30" height="30" viewBox="0 0 30 30" role="img" focusable="false"><title>Menu</title><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></div><a href="https://darklang.com" target="_blank" rel="noopener noreferrer" class="navbar__brand" to="https://darklang.com"><img class="navbar__logo" src="/img/favicon.ico" alt="Dark logo"><strong class="navbar__title">Dark</strong></a></div><div class="navbar__items navbar__items--right"><a class="navbar__item navbar__link" href="/introduction">Documentation</a><a class="navbar__item navbar__link" href="/tutorials/tutorial-intro">Tutorials &amp; Samples</a><a class="navbar__item navbar__link" href="/slack-apps/slack-intro">Building Slack Apps</a><a class="navbar__item navbar__link" href="/contributing/getting-started">Contributing</a><div class="react-toggle react-toggle--disabled displayOnlyInLargeViewport_1gtM"><div class="react-toggle-track"><div class="react-toggle-track-check"><span class="toggle_keGJ moon_1gwN"></span></div><div class="react-toggle-track-x"><span class="toggle_keGJ sun_3CPA"></span></div></div><div class="react-toggle-thumb"></div><input type="checkbox" disabled="" aria-label="Dark mode toggle" class="react-toggle-screenreader-only"></div><div class="navbar__search"><div class="searchWrapper_-F3-"><span aria-label="expand searchbar" role="button" class="searchIconButton_1Dnz" tabindex="0"></span><input type="search" id="search_input_react" placeholder="Search" aria-label="Search" class="navbar__search-input searchInput_2eto"></div></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div><div class="navbar-sidebar"><div class="navbar-sidebar__brand"><a href="https://darklang.com" target="_blank" rel="noopener noreferrer" class="navbar__brand" to="https://darklang.com"><img class="navbar__logo" src="/img/favicon.ico" alt="Dark logo"><strong class="navbar__title">Dark</strong></a></div><div class="navbar-sidebar__items"><div class="menu"><ul class="menu__list"><li class="menu__list-item"><a class="menu__link" href="/introduction">Documentation</a></li><li class="menu__list-item"><a class="menu__link" href="/tutorials/tutorial-intro">Tutorials &amp; Samples</a></li><li class="menu__list-item"><a class="menu__link" href="/slack-apps/slack-intro">Building Slack Apps</a></li><li class="menu__list-item"><a class="menu__link" href="/contributing/getting-started">Contributing</a></li></ul></div></div></div></nav><div class="main-wrapper"><div class="docPage_1kjD"><div class="docSidebarContainer_1cYp" role="complementary"><div class="sidebar_1kLs"><div class="menu menu--responsive menu_w2sC"><button aria-label="Open Menu" aria-haspopup="true" class="button button--secondary button--sm menu__button" type="button"><svg aria-label="Menu" class="sidebarMenuIcon_2vk4" xmlns="http://www.w3.org/2000/svg" height="24" width="24" viewBox="0 0 32 32" role="img" focusable="false"><title>Menu</title><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><ul class="menu__list"><li class="menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#!">Your First Contribution</a><ul class="menu__list"><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/contributing/getting-started">Getting started</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/contributing/setting-up-the-repo">Setting up the Dark repo</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/contributing/adding-your-first-test">Adding your first test</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/contributing/making-your-first-pull-request">Making your first Pull Request</a></li></ul></li><li class="menu__list-item"><a class="menu__link menu__link--sublist menu__link--active" href="#!">Your Next Contributions</a><ul class="menu__list"><li class="menu__list-item"><a class="menu__link" tabindex="0" href="/contributing/next-contribution">Your next contribution</a></li><li class="menu__list-item"><a class="menu__link" tabindex="0" href="/contributing/if-you-dont-know-ocaml">If you don&#x27;t know OCaml</a></li><li class="menu__list-item"><a class="menu__link" tabindex="0" href="/contributing/adding-a-function">Adding a built-in function</a></li><li class="menu__list-item"><a aria-current="page" class="menu__link menu__link--active active" tabindex="0" href="/contributing/adding-a-language-feature">Adding a language feature</a></li><li class="menu__list-item"><a class="menu__link" tabindex="0" href="/contributing/adding-a-refactoring">Adding a refactoring</a></li></ul></li><li class="menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#!">Working in the Dark repo</a><ul class="menu__list"><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/contributing/ocaml-for-dark-developers">OCaml for Dark developers</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/contributing/general-concepts">General concepts</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/contributing/tour-of-editor">A tour of the Editor</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/contributing/tour-of-backend">A tour of the Backend</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/contributing/repo-layout">Repository directory structure</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/contributing/glossary">Glossary</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/contributing/debugging">Debugging</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/contributing/troubleshooting">Troubleshooting</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/contributing/making-a-pull-request">Making a Pull Request</a></li></ul></li></ul></div></div></div><main class="docMainContainer_FFX1"><div class="container padding-vert--lg docItemWrapper_1cc7"><div class="row"><div class="col docItemCol_2GOA"><div class="docItemContainer_2cwg"><article><header><h1 class="docTitle_1vWb">Adding a language feature</h1></header><div class="markdown"><p>There are a number of
<a href="https://github.com/darklang/dark/issues?q=is%3Aissue+is%3Aopen+label%3Alanguage-feature" target="_blank" rel="noopener noreferrer">language features that we&#x27;d like to add</a>
to Dark. While there a quite a few steps involved in adding a language feature,
they&#x27;re typically relatively straightforward to add once you&#x27;ve figured out the
Dark codebase.</p><p>It&#x27;s important to note that the most important part of a language feature is
getting agreement on what it does. We typically write specs for features, and
ensure that we have resolved how edge cases should work, as well as ensuring it
meshes with the rest of the language and language definition. If you&#x27;re
interested in creating a language feature, you should engage with Paul Biggar
early and often.</p><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_ZqCz" id="overview"></a>Overview<a aria-hidden="true" tabindex="-1" class="hash-link" href="#overview" title="Direct link to heading">#</a></h3><p>Most language features will need to be added to our language definition. The
language definition is <code>FluidExpression.t</code>, which is a Dark expression (which in
turn contains other Dark expressions). This is commonly known as an &quot;Abstract
Syntax Tree&quot; (or AST).</p><p>At time of writing, the definition of <code>FluidExpression.t</code> was</p><div class="mdxCodeBlock_iHAB"><div class="codeBlockContent_32p_"><button type="button" aria-label="Copy code to clipboard" class="copyButton_1BYj">Copy</button><div tabindex="0" class="prism-code language-ocaml codeBlock_19pQ"><div class="codeBlockLines_2n9r" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token keyword" style="font-style:italic">type</span><span class="token plain"> t </span><span class="token operator" style="color:rgb(137, 221, 255)">=</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  </span><span class="token operator" style="color:rgb(137, 221, 255)">|</span><span class="token plain"> EInteger </span><span class="token keyword" style="font-style:italic">of</span><span class="token plain"> id </span><span class="token operator" style="color:rgb(137, 221, 255)">*</span><span class="token plain"> string</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  </span><span class="token operator" style="color:rgb(137, 221, 255)">|</span><span class="token plain"> EBool </span><span class="token keyword" style="font-style:italic">of</span><span class="token plain"> id </span><span class="token operator" style="color:rgb(137, 221, 255)">*</span><span class="token plain"> bool</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  </span><span class="token operator" style="color:rgb(137, 221, 255)">|</span><span class="token plain"> EString </span><span class="token keyword" style="font-style:italic">of</span><span class="token plain"> id </span><span class="token operator" style="color:rgb(137, 221, 255)">*</span><span class="token plain"> string</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  </span><span class="token operator" style="color:rgb(137, 221, 255)">|</span><span class="token plain"> EFloat </span><span class="token keyword" style="font-style:italic">of</span><span class="token plain"> id </span><span class="token operator" style="color:rgb(137, 221, 255)">*</span><span class="token plain"> string </span><span class="token operator" style="color:rgb(137, 221, 255)">*</span><span class="token plain"> string</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  </span><span class="token operator" style="color:rgb(137, 221, 255)">|</span><span class="token plain"> ENull </span><span class="token keyword" style="font-style:italic">of</span><span class="token plain"> id</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  </span><span class="token operator" style="color:rgb(137, 221, 255)">|</span><span class="token plain"> EBlank </span><span class="token keyword" style="font-style:italic">of</span><span class="token plain"> id</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  </span><span class="token operator" style="color:rgb(137, 221, 255)">|</span><span class="token plain"> ELet </span><span class="token keyword" style="font-style:italic">of</span><span class="token plain"> id </span><span class="token operator" style="color:rgb(137, 221, 255)">*</span><span class="token plain"> string </span><span class="token operator" style="color:rgb(137, 221, 255)">*</span><span class="token plain"> t </span><span class="token operator" style="color:rgb(137, 221, 255)">*</span><span class="token plain"> t</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  </span><span class="token operator" style="color:rgb(137, 221, 255)">|</span><span class="token plain"> EIf </span><span class="token keyword" style="font-style:italic">of</span><span class="token plain"> id </span><span class="token operator" style="color:rgb(137, 221, 255)">*</span><span class="token plain"> t </span><span class="token operator" style="color:rgb(137, 221, 255)">*</span><span class="token plain"> t </span><span class="token operator" style="color:rgb(137, 221, 255)">*</span><span class="token plain"> t</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  </span><span class="token operator" style="color:rgb(137, 221, 255)">|</span><span class="token plain"> EBinOp </span><span class="token keyword" style="font-style:italic">of</span><span class="token plain"> id </span><span class="token operator" style="color:rgb(137, 221, 255)">*</span><span class="token plain"> string </span><span class="token operator" style="color:rgb(137, 221, 255)">*</span><span class="token plain"> t </span><span class="token operator" style="color:rgb(137, 221, 255)">*</span><span class="token plain"> t </span><span class="token operator" style="color:rgb(137, 221, 255)">*</span><span class="token plain"> sendToRail</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  </span><span class="token operator" style="color:rgb(137, 221, 255)">|</span><span class="token plain"> ELambda </span><span class="token keyword" style="font-style:italic">of</span><span class="token plain"> id </span><span class="token operator" style="color:rgb(137, 221, 255)">*</span><span class="token plain"> string list </span><span class="token operator" style="color:rgb(137, 221, 255)">*</span><span class="token plain"> t</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  </span><span class="token operator" style="color:rgb(137, 221, 255)">|</span><span class="token plain"> EFieldAccess </span><span class="token keyword" style="font-style:italic">of</span><span class="token plain"> id </span><span class="token operator" style="color:rgb(137, 221, 255)">*</span><span class="token plain"> t </span><span class="token operator" style="color:rgb(137, 221, 255)">*</span><span class="token plain"> string</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  </span><span class="token operator" style="color:rgb(137, 221, 255)">|</span><span class="token plain"> EVariable </span><span class="token keyword" style="font-style:italic">of</span><span class="token plain"> id </span><span class="token operator" style="color:rgb(137, 221, 255)">*</span><span class="token plain"> string</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  </span><span class="token operator" style="color:rgb(137, 221, 255)">|</span><span class="token plain"> EFnCall </span><span class="token keyword" style="font-style:italic">of</span><span class="token plain"> id </span><span class="token operator" style="color:rgb(137, 221, 255)">*</span><span class="token plain"> string </span><span class="token operator" style="color:rgb(137, 221, 255)">*</span><span class="token plain"> t list </span><span class="token operator" style="color:rgb(137, 221, 255)">*</span><span class="token plain"> sendToRail</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  </span><span class="token comment" style="color:rgb(105, 112, 152);font-style:italic">(* An EPartial holds the intermediate state of user-input when changing from</span></div><div class="token-line" style="color:#bfc7d5"><span class="token comment" style="color:rgb(105, 112, 152);font-style:italic">   * one expression to another. The [string] is the exact text that has been</span></div><div class="token-line" style="color:#bfc7d5"><span class="token comment" style="color:rgb(105, 112, 152);font-style:italic">   * entered and the [t] is the old expression that is being changed. *)</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  </span><span class="token operator" style="color:rgb(137, 221, 255)">|</span><span class="token plain"> EPartial </span><span class="token keyword" style="font-style:italic">of</span><span class="token plain"> id </span><span class="token operator" style="color:rgb(137, 221, 255)">*</span><span class="token plain"> string </span><span class="token operator" style="color:rgb(137, 221, 255)">*</span><span class="token plain"> t</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  </span><span class="token comment" style="color:rgb(105, 112, 152);font-style:italic">(* An ERightPartial is used while in the process of adding an EBinOp,</span></div><div class="token-line" style="color:#bfc7d5"><span class="token comment" style="color:rgb(105, 112, 152);font-style:italic">   * allowing for typing multiple characters as operators (eg, &quot;++&quot;) after an</span></div><div class="token-line" style="color:#bfc7d5"><span class="token comment" style="color:rgb(105, 112, 152);font-style:italic">   * expression. The [string] holds the typed characters while the [t] holds</span></div><div class="token-line" style="color:#bfc7d5"><span class="token comment" style="color:rgb(105, 112, 152);font-style:italic">   * the LHS of the binop. *)</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  </span><span class="token operator" style="color:rgb(137, 221, 255)">|</span><span class="token plain"> ERightPartial </span><span class="token keyword" style="font-style:italic">of</span><span class="token plain"> id </span><span class="token operator" style="color:rgb(137, 221, 255)">*</span><span class="token plain"> string </span><span class="token operator" style="color:rgb(137, 221, 255)">*</span><span class="token plain"> t</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  </span><span class="token operator" style="color:rgb(137, 221, 255)">|</span><span class="token plain"> EList </span><span class="token keyword" style="font-style:italic">of</span><span class="token plain"> id </span><span class="token operator" style="color:rgb(137, 221, 255)">*</span><span class="token plain"> t list</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  </span><span class="token operator" style="color:rgb(137, 221, 255)">|</span><span class="token plain"> ERecord </span><span class="token keyword" style="font-style:italic">of</span><span class="token plain"> id </span><span class="token operator" style="color:rgb(137, 221, 255)">*</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token plain">string </span><span class="token operator" style="color:rgb(137, 221, 255)">*</span><span class="token plain"> t</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token plain"> list</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  </span><span class="token operator" style="color:rgb(137, 221, 255)">|</span><span class="token plain"> EPipe </span><span class="token keyword" style="font-style:italic">of</span><span class="token plain"> id </span><span class="token operator" style="color:rgb(137, 221, 255)">*</span><span class="token plain"> t list</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  </span><span class="token operator" style="color:rgb(137, 221, 255)">|</span><span class="token plain"> EConstructor </span><span class="token keyword" style="font-style:italic">of</span><span class="token plain"> id </span><span class="token operator" style="color:rgb(137, 221, 255)">*</span><span class="token plain"> string </span><span class="token operator" style="color:rgb(137, 221, 255)">*</span><span class="token plain"> t list</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  </span><span class="token operator" style="color:rgb(137, 221, 255)">|</span><span class="token plain"> EMatch </span><span class="token keyword" style="font-style:italic">of</span><span class="token plain"> id </span><span class="token operator" style="color:rgb(137, 221, 255)">*</span><span class="token plain"> t </span><span class="token operator" style="color:rgb(137, 221, 255)">*</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token plain">FluidPattern</span><span class="token punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token plain">t </span><span class="token operator" style="color:rgb(137, 221, 255)">*</span><span class="token plain"> t</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token plain"> list</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  </span><span class="token comment" style="color:rgb(105, 112, 152);font-style:italic">(* Placeholder that indicates the target of the Thread. May be movable at</span></div><div class="token-line" style="color:#bfc7d5"><span class="token comment" style="color:rgb(105, 112, 152);font-style:italic">   * some point *)</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  </span><span class="token operator" style="color:rgb(137, 221, 255)">|</span><span class="token plain"> EPipeTarget </span><span class="token keyword" style="font-style:italic">of</span><span class="token plain"> id</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  </span><span class="token comment" style="color:rgb(105, 112, 152);font-style:italic">(* EFeatureFlag: id, flagName, condExpr, caseAExpr, caseBExpr *)</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  </span><span class="token operator" style="color:rgb(137, 221, 255)">|</span><span class="token plain"> EFeatureFlag </span><span class="token keyword" style="font-style:italic">of</span><span class="token plain"> id </span><span class="token operator" style="color:rgb(137, 221, 255)">*</span><span class="token plain"> string </span><span class="token operator" style="color:rgb(137, 221, 255)">*</span><span class="token plain"> t </span><span class="token operator" style="color:rgb(137, 221, 255)">*</span><span class="token plain"> t </span><span class="token operator" style="color:rgb(137, 221, 255)">*</span><span class="token plain"> t</span></div></div></div></div></div><p>This definition is shared between client and backend.</p><p>The backend does the work of executing the expressions, and saving programs. The
execution engine is also compiled to Javascript in order to be available in the
client.</p><p>The client is responsible for editing programs. Typically, adding a language
feature means adding support for it to the many transformations that the client
does, including refactorings, renamings, etc. It will also need support in the
&quot;Fluid&quot; editor, which is where users actually type code.</p><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_ZqCz" id="backend"></a>Backend<a aria-hidden="true" tabindex="-1" class="hash-link" href="#backend" title="Direct link to heading">#</a></h2><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_ZqCz" id="execution"></a>Execution<a aria-hidden="true" tabindex="-1" class="hash-link" href="#execution" title="Direct link to heading">#</a></h3><p>The execution of the language is defined in <code>backend/libexecution/ast.ml:exec</code>.
<code>exec</code> does the work of converting an expressions into a <code>dval</code> -- a Dark value.</p><p>For example, <code>DInt</code> is the run-time value of an integer, which <code>EInteger</code> is the
expression that represents an integer. <code>exec</code> converts from an <code>EInteger</code> that
the programmer added to their program, into a <code>DInt</code> that can be operated on
(added, subtracted, etc).</p><p>As another example, an <code>ELet</code> is a <code>let</code> statement in Dark. When you see</p><div class="mdxCodeBlock_iHAB"><div class="codeBlockContent_32p_"><button type="button" aria-label="Copy code to clipboard" class="copyButton_1BYj">Copy</button><div tabindex="0" class="prism-code language-elm codeBlock_19pQ"><div class="codeBlockLines_2n9r" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain">let x = 6</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">x + 4</span></div></div></div></div></div><p>you have an <code>ELet (&quot;x&quot;, EInteger 6, EBinOp (&quot;+&quot;, EVariable &quot;x&quot;, EInteger 4))</code>.
When we execute this <code>ELet</code>, we first execute the <code>6</code>, creating a <code>dval</code> of
<code>DInt 6</code>, which we then store as <code>x</code> in a &quot;symbol table&quot;. We then execute
<code>x + 4</code> using the symbol table with our known value of <code>x = 6</code>.</p><p><code>dval</code>s are defined in <code>backend/libexecution/types.ml</code> and expressions are
defined in <code>libshared/fluid_expression.ml</code>.</p><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_ZqCz" id="serialization"></a>Serialization<a aria-hidden="true" tabindex="-1" class="hash-link" href="#serialization" title="Direct link to heading">#</a></h3><p>The other main purpose of the backend is to save programs. Dark uses a fast
binary serialization format, derived directly from expressions. This means you
do not have to do anything special to allow users to save your new expression.</p><h4><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_ZqCz" id="expr"></a>expr<a aria-hidden="true" tabindex="-1" class="hash-link" href="#expr" title="Direct link to heading">#</a></h4><p>Well, not exactly. We currently actually serialize an old format, called <code>expr</code>.
We convert between <code>expr</code> and <code>FluidExpression.t</code> in order to save and execute.
The client only uses <code>FluidExpression.t</code>, however.</p><h4><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_ZqCz" id="expressions-are-add-only"></a>Expressions are add-only<a aria-hidden="true" tabindex="-1" class="hash-link" href="#expressions-are-add-only" title="Direct link to heading">#</a></h4><p>The automatic serialization has a caveat: the serializer has some rules to
maintain compatibility with existing Dark programs. You can add new expression
types it, but you can&#x27;t change existing ones. This means that if you want to
change a language feature to make it more powerful, you need to instead add a
new version of it, rather than editing the current version.</p><p>We do have the ability to remove old formats, but it is a little challenging to
coordinate. Whenever we do this, it is always after the new replacement feature
is live and stable, and then we go in and remove the old one.</p><p>These rules apply to anything using the <code>bin_io</code> derivers, which currently
includes both <code>expr</code>s and <code>tipe</code>s.</p><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_ZqCz" id="editor-support"></a>Editor support<a aria-hidden="true" tabindex="-1" class="hash-link" href="#editor-support" title="Direct link to heading">#</a></h2><p>The editor is where the developer actually creates code.</p><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_ZqCz" id="fluid-editor"></a>Fluid Editor<a aria-hidden="true" tabindex="-1" class="hash-link" href="#fluid-editor" title="Direct link to heading">#</a></h3><p>The &quot;fluid&quot; editor is the subpart of the client where users type code. It
handles keypresses and the AST transformations that they cause.</p><p>For example: if you have the code (with the cursor denoted as <code>|</code>):</p><div class="mdxCodeBlock_iHAB"><div class="codeBlockContent_32p_"><button type="button" aria-label="Copy code to clipboard" class="copyButton_1BYj">Copy</button><div tabindex="0" class="prism-code language-undefined codeBlock_19pQ"><div class="codeBlockLines_2n9r" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain">let x = |6</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">x + 4</span></div></div></div></div></div><p>Pressing <code>1</code> with your cursor here makes the editor look up the current
expression, and add a <code>1</code> to the front of it. Here that converts <code>6</code> into <code>16</code>.</p><h4><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_ZqCz" id="adding-tokens"></a>Adding tokens<a aria-hidden="true" tabindex="-1" class="hash-link" href="#adding-tokens" title="Direct link to heading">#</a></h4><p>The FluidEditor works as a sort of &quot;reverse parser&quot;. Instead of reading text and
figuring out meaning, it instead takes the AST and pretty-prints it into a set
of <code>FluidToken</code>s. These tokens are stringified, showing the user textual code.</p><p>The tokens also tied the current edit back to an expression. In the example
above, the cursor is at the start of a <code>TInteger</code> token, which ties the current
position back to the <code>EInteger</code> expression that defines it.</p><p>To add a language feature, you will often need to add new tokens. You will
occasionally reuse some tokens, but most features use dedicated tokens so that
there&#x27;s no ambiguity.</p><p>You add tokens in <code>client/src/core/Types.ml</code> and keystrokes are handled in
<code>client/src/fluid/Fluid.ml:updateKey</code>.</p><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_ZqCz" id="ast-transformations"></a>AST transformations<a aria-hidden="true" tabindex="-1" class="hash-link" href="#ast-transformations" title="Direct link to heading">#</a></h3><p>Once you have added the expression and the tokens, you will need to support
existing features. Mostly, this means that existing AST transformations and
refactorings should continue to work. These are typically either explicit (via
the command palette) or implicit (by renaming a variable).</p><p>You will be able to find almost everywhere that this is needed when you add the
definition to <code>FluidExpression.t</code>. The OCaml compiler will warn you at every
place that you have not handled it.</p><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_ZqCz" id="clientbackend-communication"></a>Client/backend communication<a aria-hidden="true" tabindex="-1" class="hash-link" href="#clientbackend-communication" title="Direct link to heading">#</a></h2><p>The client sends ASTs to the backend to save and to run the programs in the
cloud. The client also fetches expressions from the backend to display and edit
them. It does this over JSON.</p><p>The backend has automatic JSON serializers and deserializers, using the <code>yojson</code>
derivers. The client has hand-written serializers in
<code>client/src/core/Encoders.ml</code> and <code>client/src/core/Decoders.ml</code>. The OCaml
compiler will prompt you to add new encoders, but not decoders. Writing new ones
is straightforward by following other examples there.</p></div></article><div class="margin-vert--lg"><nav class="pagination-nav" aria-label="Blog list page navigation"><div class="pagination-nav__item"><a class="pagination-nav__link" href="/contributing/adding-a-function"><div class="pagination-nav__sublabel">Previous</div><div class="pagination-nav__label">« Adding a built-in function</div></a></div><div class="pagination-nav__item pagination-nav__item--next"><a class="pagination-nav__link" href="/contributing/adding-a-refactoring"><div class="pagination-nav__sublabel">Next</div><div class="pagination-nav__label">Adding a refactoring »</div></a></div></nav></div></div></div><div class="col col--3"><div class="tableOfContents_TbNY"><ul class="table-of-contents table-of-contents__left-border"><li><a href="#overview" class="table-of-contents__link">Overview</a></li><li><a href="#backend" class="table-of-contents__link">Backend</a><ul><li><a href="#execution" class="table-of-contents__link">Execution</a></li><li><a href="#serialization" class="table-of-contents__link">Serialization</a></li></ul></li><li><a href="#editor-support" class="table-of-contents__link">Editor support</a><ul><li><a href="#fluid-editor" class="table-of-contents__link">Fluid Editor</a></li><li><a href="#ast-transformations" class="table-of-contents__link">AST transformations</a></li></ul></li><li><a href="#clientbackend-communication" class="table-of-contents__link">Client/backend communication</a></li></ul></div></div></div></div></main></div></div><footer class="footer footer--dark"><div class="container"><div class="row footer__links"><div class="col footer__col"><h4 class="footer__title">Learning</h4><ul class="footer__items"><li class="footer__item"><a href="https://darklang.com/launch/demo-video" target="_blank" rel="noopener noreferrer" class="footer__link-item" to="https://darklang.com/launch/demo-video">Demo Video</a></li><li class="footer__item"><a href="https://youtube.com/c/Darklang/videos" target="_blank" rel="noopener noreferrer" class="footer__link-item" to="https://youtube.com/c/Darklang/videos">Tutorial Videos</a></li><li class="footer__item"><a href="https://darklang.com/docs" target="_blank" rel="noopener noreferrer" class="footer__link-item" to="https://darklang.com/docs">Docs</a></li><li class="footer__item"><a href="https://darklang.com/docs/tutorials" target="_blank" rel="noopener noreferrer" class="footer__link-item" to="https://darklang.com/docs/tutorials">Tutorials &amp; Samples</a></li><li class="footer__item"><a href="https://darklang.com/docs/slack-apps" target="_blank" rel="noopener noreferrer" class="footer__link-item" to="https://darklang.com/docs/slack-apps">Building Slack Apps</a></li></ul></div><div class="col footer__col"><h4 class="footer__title">About</h4><ul class="footer__items"><li class="footer__item"><a href="https://darklang.com/about" target="_blank" rel="noopener noreferrer" class="footer__link-item" to="https://darklang.com/about">Company</a></li><li class="footer__item"><a href="https://dev.to/darklang" target="_blank" rel="noopener noreferrer" class="footer__link-item" to="https://dev.to/darklang">Dev Blog</a></li><li class="footer__item"><a href="https://medium.com/darklang" target="_blank" rel="noopener noreferrer" class="footer__link-item" to="https://medium.com/darklang">Corp Blog</a></li></ul></div><div class="col footer__col"><h4 class="footer__title">Community</h4><ul class="footer__items"><li class="footer__item"><a href="https://darklang.com/slack-invite" target="_blank" rel="noopener noreferrer" class="footer__link-item" to="https://darklang.com/slack-invite">Community Slack</a></li><li class="footer__item"><a href="https://github.com/darklang/dark" target="_blank" rel="noopener noreferrer" class="footer__link-item" to="https://github.com/darklang/dark">Dark Repo</a></li><li class="footer__item"><a href="https://github.com/darklang/docs" target="_blank" rel="noopener noreferrer" class="footer__link-item" to="https://github.com/darklang/docs">Docs Repo</a></li><li class="footer__item"><a class="footer__link-item" href="/contributing/getting-started">Contributor Docs</a></li><li class="footer__item"><a href="https://darklang.com/code-of-conduct" target="_blank" rel="noopener noreferrer" class="footer__link-item" to="https://darklang.com/code-of-conduct">Code of Conduct</a></li></ul></div><div class="col footer__col"><h4 class="footer__title">Product</h4><ul class="footer__items"><li class="footer__item"><a href="https://darklang.com/login" target="_blank" rel="noopener noreferrer" class="footer__link-item" to="https://darklang.com/login">Sign in</a></li><li class="footer__item"><a href="https://darklang.com/signup" target="_blank" rel="noopener noreferrer" class="footer__link-item" to="https://darklang.com/signup">Sign up</a></li><li class="footer__item"><a href="https://darklang.com/desktop-client" target="_blank" rel="noopener noreferrer" class="footer__link-item" to="https://darklang.com/desktop-client">Desktop Client</a></li><li class="footer__item"><a href="https://darklang.com/mailing-list" target="_blank" rel="noopener noreferrer" class="footer__link-item" to="https://darklang.com/mailing-list">Mailing List</a></li></ul></div></div><div class="text--center"><div>Copyright © 2020 Dark Inc. Built with Docusaurus.</div></div></div></footer></div>
<script src="/styles.07077e44.js"></script>
<script src="/runtime~main.971aee17.js"></script>
<script src="/main.70223205.js"></script>
<script src="/1.14df050a.js"></script>
<script src="/2.b7a2668d.js"></script>
<script src="/90.44038b43.js"></script>
<script src="/91.fb068903.js"></script>
<script src="/05c17924.1b0ba798.js"></script>
<script src="/17896441.60fa8c2c.js"></script>
<script src="/d9df5485.66a5954a.js"></script>
</body>
</html>