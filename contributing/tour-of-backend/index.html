<!doctype html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width">
<meta name="generator" content="Docusaurus v2.0.0-alpha.58">
<link rel="preconnect" href="https://www.google-analytics.com">
<script>window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)},ga.l=+new Date,ga("create","UA-159199190-1","auto"),ga("send","pageview")</script>
<script async src="https://www.google-analytics.com/analytics.js"></script>
<link rel="search" type="application/opensearchdescription+xml" title="Dark Documentation" href="/opensearch.xml">
<link rel="preconnect" href="https://cdn.heapanalytics.com">
<link rel="dns-prefetch" href="https://cdn.heapanalytics.com">
<script>window.heap=window.heap||[],heap.load=function(e,t){window.heap.appid=e,window.heap.config=t=t||{};var r=document.createElement("script");r.type="text/javascript",r.async=!0,r.src="https://cdn.heapanalytics.com/js/heap-"+e+".js";var a=document.getElementsByTagName("script")[0];a.parentNode.insertBefore(r,a);for(var n=function(e){return function(){heap.push([e].concat(Array.prototype.slice.call(arguments,0)))}},p=["addEventProperties","addUserProperties","clearEventProperties","identify","resetIdentity","removeEventProperty","setEventProperties","track","unsetEventProperty"],o=0;o<p.length;o++)heap[p[o]]=n(p[o])},heap.load(477722926)</script>
<link rel="preconnect" href="https://cdn.heysavvy.com">
<link rel="dns-prefetch" href="https://cdn.heysavvy.com"><title data-react-helmet="true">A tour of the Backend | Dark Documentation</title><meta data-react-helmet="true" property="og:image" content="https://docs.darklang.com/img/favicon.ico"><meta data-react-helmet="true" property="twitter:image" content="https://docs.darklang.com/img/favicon.ico"><meta data-react-helmet="true" name="twitter:image:alt" content="Image for Dark Documentation"><meta data-react-helmet="true" name="twitter:card" content="summary_large_image"><meta data-react-helmet="true" property="og:title" content="A tour of the Backend | Dark Documentation"><meta data-react-helmet="true" name="description" content="The journey of a HTTP request"><meta data-react-helmet="true" property="og:description" content="The journey of a HTTP request"><meta data-react-helmet="true" property="og:url" content="https://docs.darklang.com/contributing/tour-of-backend"><link data-react-helmet="true" rel="shortcut icon" href="/img/favicon.ico"><link data-react-helmet="true" rel="canonical" href="https://docs.darklang.com/contributing/tour-of-backend"><link rel="stylesheet" href="/styles.f03e3bc4.css">
<link rel="preload" href="/styles.07077e44.js" as="script">
<link rel="preload" href="/runtime~main.b9629a01.js" as="script">
<link rel="preload" href="/main.f7cb89d4.js" as="script">
<link rel="preload" href="/1.14df050a.js" as="script">
<link rel="preload" href="/2.b7a2668d.js" as="script">
<link rel="preload" href="/90.44038b43.js" as="script">
<link rel="preload" href="/91.fb068903.js" as="script">
<link rel="preload" href="/05c17924.1b0ba798.js" as="script">
<link rel="preload" href="/17896441.60fa8c2c.js" as="script">
<link rel="preload" href="/c83160b6.ca7957da.js" as="script">
</head>
<body>
<script>!function(){function t(t){document.documentElement.setAttribute("data-theme",t)}var e=window.matchMedia("(prefers-color-scheme: dark)"),n=function(){var t=null;try{t=localStorage.getItem("theme")}catch(t){}return t}();null!==n?t(n):e.matches&&t("dark")}()</script><div id="__docusaurus">
<nav class="navbar navbar--light navbar--fixed-top"><div class="navbar__inner"><div class="navbar__items"><div aria-label="Navigation bar toggle" class="navbar__toggle" role="button" tabindex="0"><svg xmlns="http://www.w3.org/2000/svg" width="30" height="30" viewBox="0 0 30 30" role="img" focusable="false"><title>Menu</title><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></div><a href="https://darklang.com" target="_blank" rel="noopener noreferrer" class="navbar__brand" to="https://darklang.com"><img class="navbar__logo" src="/img/favicon.ico" alt="Dark logo"><strong class="navbar__title">Dark</strong></a></div><div class="navbar__items navbar__items--right"><a class="navbar__item navbar__link" href="/introduction">Documentation</a><a class="navbar__item navbar__link" href="/tutorials/tutorial-intro">Tutorials &amp; Samples</a><a class="navbar__item navbar__link" href="/slack-apps/slack-intro">Building Slack Apps</a><a class="navbar__item navbar__link" href="/contributing/getting-started">Contributing</a><div class="react-toggle react-toggle--disabled displayOnlyInLargeViewport_1gtM"><div class="react-toggle-track"><div class="react-toggle-track-check"><span class="toggle_keGJ moon_1gwN"></span></div><div class="react-toggle-track-x"><span class="toggle_keGJ sun_3CPA"></span></div></div><div class="react-toggle-thumb"></div><input type="checkbox" disabled="" aria-label="Dark mode toggle" class="react-toggle-screenreader-only"></div><div class="navbar__search"><div class="searchWrapper_-F3-"><span aria-label="expand searchbar" role="button" class="searchIconButton_1Dnz" tabindex="0"></span><input type="search" id="search_input_react" placeholder="Search" aria-label="Search" class="navbar__search-input searchInput_2eto"></div></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div><div class="navbar-sidebar"><div class="navbar-sidebar__brand"><a href="https://darklang.com" target="_blank" rel="noopener noreferrer" class="navbar__brand" to="https://darklang.com"><img class="navbar__logo" src="/img/favicon.ico" alt="Dark logo"><strong class="navbar__title">Dark</strong></a></div><div class="navbar-sidebar__items"><div class="menu"><ul class="menu__list"><li class="menu__list-item"><a class="menu__link" href="/introduction">Documentation</a></li><li class="menu__list-item"><a class="menu__link" href="/tutorials/tutorial-intro">Tutorials &amp; Samples</a></li><li class="menu__list-item"><a class="menu__link" href="/slack-apps/slack-intro">Building Slack Apps</a></li><li class="menu__list-item"><a class="menu__link" href="/contributing/getting-started">Contributing</a></li></ul></div></div></div></nav><div class="main-wrapper"><div class="docPage_1kjD"><div class="docSidebarContainer_1cYp" role="complementary"><div class="sidebar_1kLs"><div class="menu menu--responsive menu_w2sC"><button aria-label="Open Menu" aria-haspopup="true" class="button button--secondary button--sm menu__button" type="button"><svg aria-label="Menu" class="sidebarMenuIcon_2vk4" xmlns="http://www.w3.org/2000/svg" height="24" width="24" viewBox="0 0 32 32" role="img" focusable="false"><title>Menu</title><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><ul class="menu__list"><li class="menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#!">Your First Contribution</a><ul class="menu__list"><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/contributing/getting-started">Getting started</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/contributing/setting-up-the-repo">Setting up the Dark repo</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/contributing/adding-your-first-test">Adding your first test</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/contributing/making-your-first-pull-request">Making your first Pull Request</a></li></ul></li><li class="menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#!">Your Next Contributions</a><ul class="menu__list"><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/contributing/next-contribution">Your next contribution</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/contributing/if-you-dont-know-ocaml">If you don&#x27;t know OCaml</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/contributing/adding-a-function">Adding a built-in function</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/contributing/adding-a-language-feature">Adding a language feature</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/contributing/adding-a-refactoring">Adding a refactoring</a></li></ul></li><li class="menu__list-item"><a class="menu__link menu__link--sublist menu__link--active" href="#!">Working in the Dark repo</a><ul class="menu__list"><li class="menu__list-item"><a class="menu__link" tabindex="0" href="/contributing/ocaml-for-dark-developers">OCaml for Dark developers</a></li><li class="menu__list-item"><a class="menu__link" tabindex="0" href="/contributing/general-concepts">General concepts</a></li><li class="menu__list-item"><a class="menu__link" tabindex="0" href="/contributing/tour-of-editor">A tour of the Editor</a></li><li class="menu__list-item"><a aria-current="page" class="menu__link menu__link--active active" tabindex="0" href="/contributing/tour-of-backend">A tour of the Backend</a></li><li class="menu__list-item"><a class="menu__link" tabindex="0" href="/contributing/repo-layout">Repository directory structure</a></li><li class="menu__list-item"><a class="menu__link" tabindex="0" href="/contributing/glossary">Glossary</a></li><li class="menu__list-item"><a class="menu__link" tabindex="0" href="/contributing/debugging">Debugging</a></li><li class="menu__list-item"><a class="menu__link" tabindex="0" href="/contributing/troubleshooting">Troubleshooting</a></li><li class="menu__list-item"><a class="menu__link" tabindex="0" href="/contributing/making-a-pull-request">Making a Pull Request</a></li></ul></li></ul></div></div></div><main class="docMainContainer_FFX1"><div class="container padding-vert--lg docItemWrapper_1cc7"><div class="row"><div class="col docItemCol_2GOA"><div class="docItemContainer_2cwg"><article><header><h1 class="docTitle_1vWb">A tour of the Backend</h1></header><div class="markdown"><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_ZqCz" id="the-journey-of-a-http-request"></a>The journey of a HTTP request<a aria-hidden="true" tabindex="-1" class="hash-link" href="#the-journey-of-a-http-request" title="Direct link to heading">#</a></h2><p>When the users of a Dark developer&#x27;s app (we refer to them as &quot;grand-users&quot;) makes a request to a Dark app, it makes it&#x27;s way directly to the developer&#x27;s editor.</p><p>Here&#x27;s the journey it takes:</p><ul><li>Google Load Balancer</li><li>Nginx sidecar container</li><li>the OCaml webserver in the <code>bwd</code> container</li><li>our webserver is the OCaml <a href="https://github.com/mirage/ocaml-cohttp" target="_blank" rel="noopener noreferrer">Cohttp library</a>, and it directs the request
to <code>backend/libbackend/webserver.ml:user_page_handler</code></li><li>if it&#x27;s a 404, the event is stored in the <code>stored_events_v2</code> table and
sent to the client via Stroller (a sort of reverse proxy written in
Rust)</li><li>if a page is found, the request is turned into an &quot;input value&quot;,
which is turned into a set of variables and passed to
<code>Analysis.execute_handler</code> which calls <code>AST.exec</code></li><li><code>AST.exec</code> runs the Dark code, saving parts of the trace as it goes.
Input values, function arguments and return values are saved in
Postgres tables <code>stored_events_v2</code>, <code>function_arguments</code> and
<code>function_results_v2</code></li><li>A trace is pushed to Stroller, which sends it via <a href="https://pusher.com">Pusher</a> to the
editor, where it appears as a dot on the canvas</li><li>When a user clicks on the trace, the trace is loaded from the server.
A web worker named <code>Fetcher</code> fetches the trace in the background,
decodes it, and sends the value to the editor. On the server-side, it
is fetched from <code>backend/libbackend/analysis.ml:handler_trace</code></li></ul><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_ZqCz" id="traces"></a>Traces<a aria-hidden="true" tabindex="-1" class="hash-link" href="#traces" title="Direct link to heading">#</a></h2><p>A trace is a combination of an event (referred to in Dark as an &quot;input value&quot;
and in the code as <code>StoredEvent</code>), and the arguments and results of functions
called during the trace:</p><ul><li>event refers to the HTTP request, worker event, or in the case of Crons, an
empty value, that is used to trigger the event handler</li><li>the trace includes information for every call to every function during the
event. For built-in functions, we record a hash of the arguments and the
result. For canvas functions, we also store the arguments to the function.</li></ul><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_ZqCz" id="serialization"></a>Serialization<a aria-hidden="true" tabindex="-1" class="hash-link" href="#serialization" title="Direct link to heading">#</a></h2><p>Dark programs are directly serialized in our database, and loaded for
any requests that come in. Each change in the editor creates an Op for
that toplevel (DB, handler, function, etc). That is appended to the
list of previous ops for that handler, and serialized into the DB in an
efficient binary format.</p><p>The ops contain the entire handler or function, which is much slower
than it could be (part of the reason that <code>undo</code> is so slow.</p><p>We cache/denormalize the current code for each handler, which makes
requests fast.</p><p>One downside of this is that we have to be very careful what changes we
make the Dark AST definition. There is a doc in the dark repo
discussing this in more detail.</p><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_ZqCz" id="libexecution-and-the-editor"></a><code>Libexecution</code> and the editor<a aria-hidden="true" tabindex="-1" class="hash-link" href="#libexecution-and-the-editor" title="Direct link to heading">#</a></h2><p><code>libexecution</code> is the &quot;execution engine&quot; of Dark. The same code is compiled to native code to respond to HTTP handlers, and is also compiled to Javascript to run in the editor.</p><p>The play button on functions and on handlers executes the code on the
server, returning updates to the trace of those functions. In all other
cases, the editor runs code in the JS version, filling in the results
of the functions it doesn&#x27;t have access to from the traces.</p><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_ZqCz" id="standard-library"></a>Standard library<a aria-hidden="true" tabindex="-1" class="hash-link" href="#standard-library" title="Direct link to heading">#</a></h2><p>The standard library is split between <code>backend/libexecution/lib*.ml</code>
(for functions which are available on the client and backend) and
<code>backend/libbackend/lib*.ml</code> for functions which are only available on
the backend (typically functions where we cannot compile some library
to JS).</p></div></article><div class="margin-vert--lg"><nav class="pagination-nav" aria-label="Blog list page navigation"><div class="pagination-nav__item"><a class="pagination-nav__link" href="/contributing/tour-of-editor"><div class="pagination-nav__sublabel">Previous</div><div class="pagination-nav__label">« A tour of the Editor</div></a></div><div class="pagination-nav__item pagination-nav__item--next"><a class="pagination-nav__link" href="/contributing/repo-layout"><div class="pagination-nav__sublabel">Next</div><div class="pagination-nav__label">Repository directory structure »</div></a></div></nav></div></div></div><div class="col col--3"><div class="tableOfContents_TbNY"><ul class="table-of-contents table-of-contents__left-border"><li><a href="#the-journey-of-a-http-request" class="table-of-contents__link">The journey of a HTTP request</a></li><li><a href="#traces" class="table-of-contents__link">Traces</a></li><li><a href="#serialization" class="table-of-contents__link">Serialization</a></li><li><a href="#libexecution-and-the-editor" class="table-of-contents__link"><code>Libexecution</code> and the editor</a></li><li><a href="#standard-library" class="table-of-contents__link">Standard library</a></li></ul></div></div></div></div></main></div></div><footer class="footer footer--dark"><div class="container"><div class="row footer__links"><div class="col footer__col"><h4 class="footer__title">Learning</h4><ul class="footer__items"><li class="footer__item"><a href="https://darklang.com/launch/demo-video" target="_blank" rel="noopener noreferrer" class="footer__link-item" to="https://darklang.com/launch/demo-video">Demo Video</a></li><li class="footer__item"><a href="https://youtube.com/c/Darklang/videos" target="_blank" rel="noopener noreferrer" class="footer__link-item" to="https://youtube.com/c/Darklang/videos">Tutorial Videos</a></li><li class="footer__item"><a href="https://darklang.com/docs" target="_blank" rel="noopener noreferrer" class="footer__link-item" to="https://darklang.com/docs">Docs</a></li><li class="footer__item"><a href="https://darklang.com/docs/tutorials" target="_blank" rel="noopener noreferrer" class="footer__link-item" to="https://darklang.com/docs/tutorials">Tutorials &amp; Samples</a></li><li class="footer__item"><a href="https://darklang.com/docs/slack-apps" target="_blank" rel="noopener noreferrer" class="footer__link-item" to="https://darklang.com/docs/slack-apps">Building Slack Apps</a></li></ul></div><div class="col footer__col"><h4 class="footer__title">About</h4><ul class="footer__items"><li class="footer__item"><a href="https://darklang.com/about" target="_blank" rel="noopener noreferrer" class="footer__link-item" to="https://darklang.com/about">Company</a></li><li class="footer__item"><a href="https://dev.to/darklang" target="_blank" rel="noopener noreferrer" class="footer__link-item" to="https://dev.to/darklang">Dev Blog</a></li><li class="footer__item"><a href="https://medium.com/darklang" target="_blank" rel="noopener noreferrer" class="footer__link-item" to="https://medium.com/darklang">Corp Blog</a></li></ul></div><div class="col footer__col"><h4 class="footer__title">Community</h4><ul class="footer__items"><li class="footer__item"><a href="https://darklang.com/slack-invite" target="_blank" rel="noopener noreferrer" class="footer__link-item" to="https://darklang.com/slack-invite">Community Slack</a></li><li class="footer__item"><a href="https://github.com/darklang/dark" target="_blank" rel="noopener noreferrer" class="footer__link-item" to="https://github.com/darklang/dark">Dark Repo</a></li><li class="footer__item"><a href="https://github.com/darklang/docs" target="_blank" rel="noopener noreferrer" class="footer__link-item" to="https://github.com/darklang/docs">Docs Repo</a></li><li class="footer__item"><a class="footer__link-item" href="/contributing/getting-started">Contributor Docs</a></li><li class="footer__item"><a href="https://darklang.com/code-of-conduct" target="_blank" rel="noopener noreferrer" class="footer__link-item" to="https://darklang.com/code-of-conduct">Code of Conduct</a></li></ul></div><div class="col footer__col"><h4 class="footer__title">Product</h4><ul class="footer__items"><li class="footer__item"><a href="https://darklang.com/login" target="_blank" rel="noopener noreferrer" class="footer__link-item" to="https://darklang.com/login">Sign in</a></li><li class="footer__item"><a href="https://darklang.com/signup" target="_blank" rel="noopener noreferrer" class="footer__link-item" to="https://darklang.com/signup">Sign up</a></li><li class="footer__item"><a href="https://darklang.com/desktop-client" target="_blank" rel="noopener noreferrer" class="footer__link-item" to="https://darklang.com/desktop-client">Desktop Client</a></li><li class="footer__item"><a href="https://darklang.com/mailing-list" target="_blank" rel="noopener noreferrer" class="footer__link-item" to="https://darklang.com/mailing-list">Mailing List</a></li></ul></div></div><div class="text--center"><div>Copyright © 2020 Dark Inc. Built with Docusaurus.</div></div></div></footer></div>
<script src="/styles.07077e44.js"></script>
<script src="/runtime~main.b9629a01.js"></script>
<script src="/main.f7cb89d4.js"></script>
<script src="/1.14df050a.js"></script>
<script src="/2.b7a2668d.js"></script>
<script src="/90.44038b43.js"></script>
<script src="/91.fb068903.js"></script>
<script src="/05c17924.1b0ba798.js"></script>
<script src="/17896441.60fa8c2c.js"></script>
<script src="/c83160b6.ca7957da.js"></script>
<script async="true" defer="true" src="https://cdn.heysavvy.com/wc/savvy.min.js"></script>
        <savvy-smart-form id="6HBmUjmI12nCuopyvB0B"></savvy-smart-form></body>
</html>