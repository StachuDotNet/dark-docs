(window.webpackJsonp=window.webpackJsonp||[]).push([[13],{166:function(e,t,a){"use strict";a.r(t),a.d(t,"frontMatter",(function(){return r})),a.d(t,"metadata",(function(){return l})),a.d(t,"rightToc",(function(){return c})),a.d(t,"default",(function(){return s}));var n=a(2),o=a(11),i=(a(0),a(242)),r={id:"slack-app-tutorial",title:"Slack tutorial",sidebar_label:"Slack tutorial"},l={id:"slack-app-tutorial",isDocsHomePage:!1,title:"Slack tutorial",description:"Watch a demo video of a Slack app:",source:"@site/docs/slack-app-tutorial.md",permalink:"/slack-app-tutorial",sidebar_label:"Slack tutorial",sidebar:"Slack",previous:{title:"Create a New Trello Card from Slack",permalink:"/slack-apps/tutorials/new-trello-card"}},c=[{value:"Getting started",id:"getting-started",children:[]},{value:"Creating a Slack App",id:"creating-a-slack-app",children:[{value:"Step One: Setting up OAuth (Relatively Painless!)",id:"step-one-setting-up-oauth-relatively-painless",children:[]},{value:"Step Two: Building Application Functionality &amp; Working with Slack\u2019s Payload",id:"step-two-building-application-functionality--working-with-slacks-payload",children:[]}]},{value:"Supporting Slack Commands",id:"supporting-slack-commands",children:[]},{value:"Supporting Bots &amp; Event Subscriptions",id:"supporting-bots--event-subscriptions",children:[]},{value:"Handling Incoming Data",id:"handling-incoming-data",children:[]}],p={rightToc:c};function s(e){var t=e.components,a=Object(o.a)(e,["components"]);return Object(i.b)("wrapper",Object(n.a)({},p,a,{components:t,mdxType:"MDXLayout"}),Object(i.b)("p",null,"Watch a demo video of a Slack app:\n",Object(i.b)("a",Object(n.a)({parentName:"p"},{href:"https://vimeo.com/380770154"}),"https://vimeo.com/380770154")),Object(i.b)("h2",{id:"getting-started"},"Getting started"),Object(i.b)("p",null,"Dark allows you to build backends (API endpoints, workers, cron, and data\nstorage) by writing only your business logic, using production traces. You can\naccess your account from darklang.com/a/USERNAME-CANVASNAME. For this project we\nrecommend darklang.com/a/USERNAME-slackapp."),Object(i.b)("p",null,"We recommend building a hello world API endpoint to get a feel for Dark, as\nfollows:"),Object(i.b)("p",null,Object(i.b)("img",Object(n.a)({parentName:"p"},{src:"/img/slack/image7.gif",alt:"ck/image7.gif"}))),Object(i.b)("p",null,"All the major handlers work the same way, but the key for many requests is\nworking directly with incoming data. If you\u2019ve never used Dark before, it may be\nhelpful to take a quick look at the\n",Object(i.b)("a",Object(n.a)({parentName:"p"},{href:"https://docs.google.com/document/d/1swhQBeCx1Ykly1SJfjVFiPiXuevcEyzPLkc04dMKbgQ/edit#heading=h.75uupsex1kqv"}),"editor explanation"),"."),Object(i.b)("p",null,"This guide will walk you through how to set up a Slack application, trigger\nevents from it, and write the corresponding backend logic. Our app is called Lou\nDog to the Rescue and sends photos of Lou, (one of) our office dogs."),Object(i.b)("h2",{id:"creating-a-slack-app"},"Creating a Slack App"),Object(i.b)("p",null,"Create a new Slack App from ",Object(i.b)("a",Object(n.a)({parentName:"p"},{href:"https://api.slack.com/"}),"https://api.slack.com/")),Object(i.b)("p",null,"In order to install the app to your workspace, you\u2019ll need to have the proper\npermissions. If you can\u2019t, you can\n",Object(i.b)("a",Object(n.a)({parentName:"p"},{href:"https://slack.com/create"}),"set up your own workspace")," for testing instead.\nPlease don\u2019t use the Dark community Slack, as it\u2019s a free community and we can\u2019t\nsupport them all."),Object(i.b)("p",null,"In order to install your app to your workspace, or distribute it elsewhere, your\napp will need to support at least one feature or functionality."),Object(i.b)("p",null,"Add a /test slash command to start, and point the request URL at\nUSERNAME-CANVASNAME.builtwithdark.com/test:"),Object(i.b)("p",null,Object(i.b)("img",Object(n.a)({parentName:"p"},{src:"/img/slack/image17.png",alt:"ck/mage17.png"}))),Object(i.b)("p",null,"(If you\u2019d like, you can add other features & functionality here, like a bot, but\nthis is enough to build the base of the application and get started)."),Object(i.b)("h3",{id:"step-one-setting-up-oauth-relatively-painless"},"Step One: Setting up OAuth (Relatively Painless!)"),Object(i.b)("p",null,"In order to allow your app to be distributed, let\u2019s quickly set up OAuth\n(",Object(i.b)("a",Object(n.a)({parentName:"p"},{href:"https://api.slack.com/docs/oauth"}),"Slack\u2019s OAuth Documentation"),")."),Object(i.b)("p",null,Object(i.b)("strong",{parentName:"p"},"Manage Distribution.")," From your Slack App\u2019s Manage Distribution page, add a\nredirect URL."),Object(i.b)("p",null,Object(i.b)("img",Object(n.a)({parentName:"p"},{src:"/img/slack/image11.png",alt:"ck/image11.png"}))),Object(i.b)("p",null,"The URL you provide will need to be in the following format:\n",Object(i.b)("a",Object(n.a)({parentName:"p"},{href:"https://username-canvasname.builtwithdark.com/oauth-redirect"}),"https://USERNAME-CANVASNAME.builtwithdark.com/OAUTH-REDIRECT")),Object(i.b)("p",null,"Make sure you click on the option to Save URLs, then navigate to ",Object(i.b)("strong",{parentName:"p"},"Settings >\nManage Distribution")," and copy the Shareable URL to your browser\u2019s address bar."),Object(i.b)("p",null,"--"),Object(i.b)("p",null,Object(i.b)("strong",{parentName:"p"},Object(i.b)("em",{parentName:"strong"},"Before continuing, please visit the Shareable URL to install the\napplication."))," By visiting this URL, you\u2019re making sure you have a real trace\nto work from in Dark. If you\u2019re new to Dark,\n",Object(i.b)("a",Object(n.a)({parentName:"p"},{href:"/trace-driven-development"}),"Trace driven development")," is a good overview of\nwhy."),Object(i.b)("p",null,"--"),Object(i.b)("p",null,"Once you click on ",Object(i.b)("strong",{parentName:"p"},"Allow"),", and then you\u2019ll see a 404 error, since we haven\u2019t\nwritten the backend logic."),Object(i.b)("p",null,"Go back to your Dark canvas; we\u2019ll use this 404 to start building."),Object(i.b)("p",null,"In Dark, you work with production traces to build your backend. ",Object(i.b)("strong",{parentName:"p"},"Click on the\n\u201c+\u201d")," next to your 404 to create an HTTP handler that will respond to OAuth\nrequests."),Object(i.b)("p",null,Object(i.b)("img",Object(n.a)({parentName:"p"},{src:"/img/slack/image19.png",alt:"ck/image19.png"}))),Object(i.b)("p",null,Object(i.b)("img",Object(n.a)({parentName:"p"},{src:"/img/slack/image10.png",alt:"ck/image10.png"}))),Object(i.b)("p",null,"After creating the route, you\u2019ll see the trace showing the full request that\nSlack made to your Dark app. This includes the code you\u2019ll need to send back to\nSlack."),Object(i.b)("p",null,"Before we send it, you\u2019ll need your ",Object(i.b)("inlineCode",{parentName:"p"},"client_id")," and ",Object(i.b)("inlineCode",{parentName:"p"},"client_secret"),", which you\ncan get from Slack\u2019s ",Object(i.b)("strong",{parentName:"p"},"Basic Information")," page."),Object(i.b)("p",null,Object(i.b)("img",Object(n.a)({parentName:"p"},{src:"/img/slack/image18.png",alt:"ck/image18.png"}))),Object(i.b)("p",null,"Type the code below into your handler in Dark. As you enter it, you\u2019ll see that\nthe trace is used to show you the results of your code, as well as helping the\nautocomplete. When copy/pasting your ",Object(i.b)("inlineCode",{parentName:"p"},"client_id")," and ",Object(i.b)("inlineCode",{parentName:"p"},"secret_id"),", you\u2019ll need to\nopen the string literal first (",Object(i.b)("inlineCode",{parentName:"p"},'"'),") and then paste (otherwise it looks like a\nfloat and is truncated)."),Object(i.b)("p",null,"This is the end result, but you\u2019ll see your ",Object(i.b)("inlineCode",{parentName:"p"},"client_id")," and ",Object(i.b)("inlineCode",{parentName:"p"},"client_secret"),"\ninstead of placeholders:"),Object(i.b)("p",null,Object(i.b)("img",Object(n.a)({parentName:"p"},{src:"/img/slack/oauthv2.png",alt:"ck/image9.png"}))),Object(i.b)("p",null,"This calls part of Slack\u2019s API\n(",Object(i.b)("a",Object(n.a)({parentName:"p"},{href:"https://api.slack.com/methods/oauth.access"}),Object(i.b)("inlineCode",{parentName:"a"},"oauth.access")),"), which will give\nyou access to the Slack app that requested it."),Object(i.b)("p",null,"When you\u2019ve done this correctly and hit \u201cplay\u201d to make the call\n(",Object(i.b)("a",Object(n.a)({parentName:"p"},{href:"/trace-driven-development#live-values--play-buttons"}),"more on play buttons)"),",\nyou\u2019ll get a response that has the right fields. This will include ",Object(i.b)("inlineCode",{parentName:"p"},"team_id")," and\nan ",Object(i.b)("inlineCode",{parentName:"p"},"access_token"),". (This may also have a ",Object(i.b)("inlineCode",{parentName:"p"},"bot_access_token")," if you add a bot to\nyour Slack functionality)."),Object(i.b)("p",null,"If you get an error in a response, you won\u2019t be able to keep going. If the code\nexpired, you\u2019ll need to re-open the shareable link from Slack in the browser to\nre-authenticate."),Object(i.b)("p",null,Object(i.b)("img",Object(n.a)({parentName:"p"},{src:"/img/slack/image12.png",alt:"ck/image12.png"}))),Object(i.b)("p",null,"You can save the response to a variable by inserting a let (",Object(i.b)("inlineCode",{parentName:"p"},"Cmd/Ctrl-\\")," ->\n",Object(i.b)("inlineCode",{parentName:"p"},"wrap-in-let"),"). You can also just hit return at the end of the function and it\nwill do the same thing:"),Object(i.b)("p",null,Object(i.b)("img",Object(n.a)({parentName:"p"},{src:"/img/slack/image4.gif",alt:"ck/image4.gif"}))),Object(i.b)("p",null,"Now save the tokens you receive to a Datastore."),Object(i.b)("p",null,"Create a new datastore from the omnibox, and set up a schema that matches the\nfields you want to save (in our example for Lou the Dog, ",Object(i.b)("inlineCode",{parentName:"p"},"team_id")," and\n",Object(i.b)("inlineCode",{parentName:"p"},"access_token")," - depending on your feature set you might not have a\n",Object(i.b)("inlineCode",{parentName:"p"},"bot_token"),")."),Object(i.b)("p",null,Object(i.b)("img",Object(n.a)({parentName:"p"},{src:"/img/slack/tokensdb.png",alt:"ck/image5.png"}))),Object(i.b)("p",null,"Then, write the following logic to put values in the datastore (this requires a\nsuccessful exchange of code for token)."),Object(i.b)("p",null,Object(i.b)("img",Object(n.a)({parentName:"p"},{src:"/img/slack/oauth-redirect.png",alt:"ck/image20.png"}))),Object(i.b)("p",null,"Our sample canvas showing this OAuth for Slack can be found\n",Object(i.b)("a",Object(n.a)({parentName:"p"},{href:"https://darklang.com/a/sample-slackoauth"}),"here"),"."),Object(i.b)("h3",{id:"step-two-building-application-functionality--working-with-slacks-payload"},"Step Two: Building Application Functionality & Working with Slack\u2019s Payload"),Object(i.b)("p",null,"Now that you\u2019ve installed the app to your workspace, you can build app\nfunctionality. We\u2019re not going to go through everything you can do, but rather\ngive you an overview."),Object(i.b)("h2",{id:"supporting-slack-commands"},"Supporting Slack Commands"),Object(i.b)("p",null,"Slack\u2019s ",Object(i.b)("strong",{parentName:"p"},"Basic Information")," page lets you create slash commands, event\nsubscriptions, and interactive components. All three of these options require a\nRequest URL, which is just a URL pointing to your Dark app, in the same format\nas before:"),Object(i.b)("p",null,Object(i.b)("a",Object(n.a)({parentName:"p"},{href:"https://username-canvasname.builtwithdark.com/ROUTE"}),"https://USERNAME-CANVASNAME.builtwithdark.com/ROUTE")),Object(i.b)("p",null,"Trigger one of these routes, and then use the 404 and trace to build out the\nfunctionality, in the same way you did with OAuth."),Object(i.b)("p",null,"For instance, if you used the sample slash command, /test, you\u2019d get this result\nafter triggering it in Slack (and it would appear in your 404 section in Dark)."),Object(i.b)("p",null,Object(i.b)("img",Object(n.a)({parentName:"p"},{src:"/img/slack/image13.png",alt:"ck/image13.png"}))),Object(i.b)("p",null,Object(i.b)("img",Object(n.a)({parentName:"p"},{src:"/img/slack/image14.png",alt:"ck/image14.png"}))),Object(i.b)("p",null,"When you create the endpoint from the 404 section, you\u2019ll be able to work with\nthe trace:"),Object(i.b)("p",null,Object(i.b)("img",Object(n.a)({parentName:"p"},{src:"/img/slack/image16.png",alt:"ck/image16.png"}))),Object(i.b)("h2",{id:"supporting-bots--event-subscriptions"},"Supporting Bots & Event Subscriptions"),Object(i.b)("p",null,"You can set up a bot that listens for its name by adding\n",Object(i.b)("a",Object(n.a)({parentName:"p"},{href:"https://api.slack.com/events/app_mention"}),Object(i.b)("inlineCode",{parentName:"a"},"app_mention"))," under Subscribe to bot\nevents in ",Object(i.b)("strong",{parentName:"p"},"Features > Event Subscriptions"),"."),Object(i.b)("p",null,"The command will be sent to the URL you specify and, like OAuth, the route will\nshow up in your 404s. Event subscriptions require that you respond with a\nchallenge parameter to validate the URL that handles that interactivity. This\nchallenge is only sent once, but you can wrap the challenge response in an\nif/else in the event that you need to validate this URL again:"),Object(i.b)("p",null,Object(i.b)("img",Object(n.a)({parentName:"p"},{src:"/img/slack/image21.png",alt:"ck/image21.png"}))),Object(i.b)("h2",{id:"handling-incoming-data"},"Handling Incoming Data"),Object(i.b)("p",null,"Once you\u2019ve set up your request URL or event subscription, you\u2019ll be able to\nreceive and work with incoming requests."),Object(i.b)("p",null,Object(i.b)("img",Object(n.a)({parentName:"p"},{src:"/img/slack/image2.png",alt:"ck/image2.png"}))),Object(i.b)("p",null,"As before, use the trace to extract the values you\u2019ll need to post your\nresponse."),Object(i.b)("p",null,"So far, we\u2019ve typically posted a message to Slack directly from an HTTP handler.\nHowever, it\u2019s better practice to do this using background workers when posting\nto external API endpoints. Workers respond to events asynchronously, and queue\nevents if they fail. You can use ",Object(i.b)("strong",{parentName:"p"},"emit")," to trigger a worker, and when you hit\nplay, you\u2019ll see the worker appear in your 404s. Here is the full events\nhandler:"),Object(i.b)("p",null,Object(i.b)("img",Object(n.a)({parentName:"p"},{src:"/img/slack/fulleventshandler.png",alt:"ck/image1.png"}))),Object(i.b)("p",null,"We\u2019ll use Slack\u2019s\n",Object(i.b)("a",Object(n.a)({parentName:"p"},{href:"https://api.slack.com/methods/chat.postMessage"}),Object(i.b)("inlineCode",{parentName:"a"},"postMessage"))," method to\nrespond to a direct mention with a message in Slack, and write the code to post\nthe response in our worker:"),Object(i.b)("p",null,Object(i.b)("img",Object(n.a)({parentName:"p"},{src:"/img/slack/image3.png",alt:"ck/image3.png"}))),Object(i.b)("p",null,Object(i.b)("img",Object(n.a)({parentName:"p"},{src:"/img/slack/image6.png",alt:"ck/image6.png"}))),Object(i.b)("p",null,"If you want to support interactivity that involves working with buttons, menus,\nor fields within a modal, this may change the shape of Slack\u2019s payload into a\nstring with nested lists. There are several functions you can use that will help\nwith data wrangling in those cases:"),Object(i.b)("ul",null,Object(i.b)("li",{parentName:"ul"},Object(i.b)("inlineCode",{parentName:"li"},"JSON::parse")," - Parses a JSON string and returns its value."),Object(i.b)("li",{parentName:"ul"},Object(i.b)("inlineCode",{parentName:"li"},"Lambda")," (or ",Object(i.b)("inlineCode",{parentName:"li"},"\\"),") - for creating anonymous functions that are most helpful\nwhen iterating through lists"),Object(i.b)("li",{parentName:"ul"},Object(i.b)("inlineCode",{parentName:"li"},"|>")," (or shift+enter) - to pipe into another expression"),Object(i.b)("li",{parentName:"ul"},Object(i.b)("inlineCode",{parentName:"li"},"List::getAt")," - For when you know the index of the nested list that contains\nyour value.")),Object(i.b)("p",null,"Here is an example of where most of these functions are used to extract the\nright values and to help draft a reply:"),Object(i.b)("p",null,Object(i.b)("img",Object(n.a)({parentName:"p"},{src:"/img/slack/image8.png",alt:"ck/image8.png"}))))}s.isMDXComponent=!0},242:function(e,t,a){"use strict";a.d(t,"a",(function(){return b})),a.d(t,"b",(function(){return d}));var n=a(0),o=a.n(n);function i(e,t,a){return t in e?Object.defineProperty(e,t,{value:a,enumerable:!0,configurable:!0,writable:!0}):e[t]=a,e}function r(e,t){var a=Object.keys(e);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);t&&(n=n.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),a.push.apply(a,n)}return a}function l(e){for(var t=1;t<arguments.length;t++){var a=null!=arguments[t]?arguments[t]:{};t%2?r(Object(a),!0).forEach((function(t){i(e,t,a[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(a)):r(Object(a)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(a,t))}))}return e}function c(e,t){if(null==e)return{};var a,n,o=function(e,t){if(null==e)return{};var a,n,o={},i=Object.keys(e);for(n=0;n<i.length;n++)a=i[n],t.indexOf(a)>=0||(o[a]=e[a]);return o}(e,t);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(e);for(n=0;n<i.length;n++)a=i[n],t.indexOf(a)>=0||Object.prototype.propertyIsEnumerable.call(e,a)&&(o[a]=e[a])}return o}var p=o.a.createContext({}),s=function(e){var t=o.a.useContext(p),a=t;return e&&(a="function"==typeof e?e(t):l(l({},t),e)),a},b=function(e){var t=s(e.components);return o.a.createElement(p.Provider,{value:t},e.children)},u={inlineCode:"code",wrapper:function(e){var t=e.children;return o.a.createElement(o.a.Fragment,{},t)}},m=o.a.forwardRef((function(e,t){var a=e.components,n=e.mdxType,i=e.originalType,r=e.parentName,p=c(e,["components","mdxType","originalType","parentName"]),b=s(a),m=n,d=b["".concat(r,".").concat(m)]||b[m]||u[m]||i;return a?o.a.createElement(d,l(l({ref:t},p),{},{components:a})):o.a.createElement(d,l({ref:t},p))}));function d(e,t){var a=arguments,n=t&&t.mdxType;if("string"==typeof e||n){var i=a.length,r=new Array(i);r[0]=m;var l={};for(var c in t)hasOwnProperty.call(t,c)&&(l[c]=t[c]);l.originalType=e,l.mdxType="string"==typeof e?e:n,r[1]=l;for(var p=2;p<i;p++)r[p]=a[p];return o.a.createElement.apply(null,r)}return o.a.createElement.apply(null,a)}m.displayName="MDXCreateElement"}}]);